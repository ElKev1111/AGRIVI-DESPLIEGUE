Package Controlador;
import DAO.PedidoProveedorDAO;
import Modelo.PedidoProveedor;
import java.io.Serializable;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import javax.annotation.PostConstruct; // Importante: Nuevo import para inicializaci√≥n
import javax.faces.application.FacesMessage;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.ViewScoped;
import javax.faces.context.FacesContext;

@ManagedBean
@ViewScoped
public class PedidoProveedorBean implements Serializable {
    
    private List<PedidoProveedor> pedidos = new ArrayList<>();
    private PedidoProveedorDAO pedidoDAO;
    private String filtroEstado;

    /**
     * Inicializa el Bean y carga el DAO. Es la mejor pr√°ctica en JSF.
     */
    @PostConstruct 
    public void init() {
        System.out.println("üîÑ Inicializando PedidoProveedorBean...");
        try {
            // Asumiendo que PedidoProveedorDAO() maneja la conexi√≥n y creaci√≥n de la tabla/datos de prueba
            pedidoDAO = new PedidoProveedorDAO();
            cargarPedidos();
            System.out.println("‚úÖ PedidoProveedorBean inicializado correctamente");
        } catch (Exception e) {
            System.out.println("‚ùå Error al inicializar PedidoProveedorBean: " + e.getMessage());
            e.printStackTrace();
            FacesContext.getCurrentInstance().addMessage(null,
                    new FacesMessage(FacesMessage.SEVERITY_ERROR, "Error", "Error al inicializar el sistema"));
        }
    }

    public void cargarPedidos() {
        try {
            if (pedidoDAO == null) {
                // Intento de recuperaci√≥n si el DAO no se inicializ√≥ correctamente
                pedidoDAO = new PedidoProveedorDAO();
            }
            
            if (filtroEstado == null || filtroEstado.isEmpty()) {
                pedidos = pedidoDAO.listar();
            } else {
                pedidos = pedidoDAO.listarPorEstado(filtroEstado);
            }
            System.out.println("‚úÖ Pedidos cargados: " + pedidos.size());
        } catch (SQLException e) {
            System.out.println("‚ùå Error al cargar pedidos (SQLException): " + e.getMessage());
            e.printStackTrace();
            FacesContext.getCurrentInstance().addMessage(null,
                    new FacesMessage(FacesMessage.SEVERITY_ERROR, "Error", "No se pudieron cargar los pedidos"));
            pedidos = new ArrayList<>(); // Asegura que la lista sea segura (no nula)
        } catch (Exception e) {
            System.out.println("‚ùå Error inesperado al cargar pedidos: " + e.getMessage());
            e.printStackTrace();
            FacesContext.getCurrentInstance().addMessage(null,
                    new FacesMessage(FacesMessage.SEVERITY_ERROR, "Error", "Error inesperado al cargar los pedidos"));
            pedidos = new ArrayList<>();
        }
    }

    public void aceptarPedido(PedidoProveedor pedido) {
        try {
            if (pedidoDAO.actualizarEstado(pedido.getIdPedido(), "ACEPTADO")) {
                FacesContext.getCurrentInstance().addMessage(null,
                        new FacesMessage(FacesMessage.SEVERITY_INFO, "√âxito", "Pedido aceptado correctamente"));
                cargarPedidos();
            } else {
                FacesContext.getCurrentInstance().addMessage(null,
                        new FacesMessage(FacesMessage.SEVERITY_ERROR, "Error", "No se pudo aceptar el pedido"));
            }
        } catch (SQLException e) {
            System.out.println("‚ùå Error al aceptar pedido: " + e.getMessage());
            FacesContext.getCurrentInstance().addMessage(null,
                    new FacesMessage(FacesMessage.SEVERITY_ERROR, "Error", "Error al aceptar el pedido"));
        }
    }

    public void rechazarPedido(PedidoProveedor pedido) {
        try {
            if (pedidoDAO.actualizarEstado(pedido.getIdPedido(), "RECHAZADO")) {
                FacesContext.getCurrentInstance().addMessage(null,
                        new FacesMessage(FacesMessage.SEVERITY_INFO, "√âxito", "Pedido rechazado correctamente"));
                cargarPedidos();
            } else {
                FacesContext.getCurrentInstance().addMessage(null,
                        new FacesMessage(FacesMessage.SEVERITY_ERROR, "Error", "No se pudo rechazar el pedido"));
            }
        } catch (SQLException e) {
            System.out.println("‚ùå Error al rechazar pedido: " + e.getMessage());
            FacesContext.getCurrentInstance().addMessage(null,
                    new FacesMessage(FacesMessage.SEVERITY_ERROR, "Error", "Error al rechazar el pedido"));
        }
    }

    /**
     * M√©todo central para contar pedidos por estado.
     * Usado internamente por los nuevos Getters.
     */
    public int getCountByEstado(String estado) {
        int count = 0;
        if (pedidos == null) return 0;
        
        for (PedidoProveedor pedido : pedidos) {
            if (pedido.getEstado() != null && pedido.getEstado().equals(estado)) {
                count++;
            }
        }
        return count;
    }

    // ========================================================
    // GETTERS PARA LOS CONTADORES (REQUERIDOS POR EL XHML)
    // ========================================================
    
    // Total de todos los pedidos
    public int getTotalPedidos() {
        return pedidos != null ? pedidos.size() : 0;
    }
    
    // Total de pedidos en estado 'ESPERA'
    public int getTotalPendientes() {
        return getCountByEstado("ESPERA");
    }
    
    // Total de pedidos en estado 'ACEPTADO'
    public int getTotalAceptados() {
        return getCountByEstado("ACEPTADO");
    }
    
    // Total de pedidos en estado 'RECHAZADO'
    public int getTotalRechazados() {
        return getCountByEstado("RECHAZADO");
    }


    // Getters y Setters
    public List<PedidoProveedor> getPedidos() { 
        return pedidos; 
    }
    
    public void setPedidos(List<PedidoProveedor> pedidos) { 
        this.pedidos = pedidos; 
    }

    public String getFiltroEstado() { 
        return filtroEstado; 
    }
    
    public void setFiltroEstado(String filtroEstado) { 
        this.filtroEstado = filtroEstado;
        cargarPedidos();
    }
}